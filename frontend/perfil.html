<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Meu Trabalho</title>
    <!-- Script de detec√ß√£o de servidor ativo - executa imediatamente -->
    <script>
        (function() {
            const currentHost = window.location.hostname;
            const currentPort = window.location.port || '5000';
            const currentPath = window.location.pathname;
            // Sempre usar portas diferentes (estrat√©gia de portas)
            const servers = ['5000', '5001', '5002'];
            
            let testedCurrent = false;
            
            async function testServer(serverAddr) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 2000);
                    // Se serverAddr √© s√≥ a porta, usar currentHost
                    const url = serverAddr.includes(':') 
                        ? `http://${serverAddr}/api/health` 
                        : `http://${currentHost}:${serverAddr}/api/health`;
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'include',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response && response.ok;
                } catch (e) {
                    return false;
                }
            }
            
            async function checkAndRedirect() {
                // Testar servidor atual primeiro
                if (!testedCurrent) {
                    testedCurrent = true;
                    const currentActive = await testServer(currentPort);
                    if (currentActive) {
                        return; // Servidor atual est√° ativo, continuar normalmente
                    }
                }
                
                // Se servidor atual n√£o est√° ativo, tentar outros
                for (const server of servers) {
                    if (server !== currentPort) {
                        const isActive = await testServer(server);
                        if (isActive) {
                            // Redirecionar para servidor ativo
                            const redirectUrl = server.includes(':') 
                                ? `http://${server}${currentPath}${window.location.search}`
                                : `http://${currentHost}:${server}${currentPath}${window.location.search}`;
                            console.log(`üîÑ Redirecionando para servidor ativo: ${redirectUrl}`);
                            window.location.replace(redirectUrl);
                            return;
                        }
                    }
                }
                
                // Se nenhum servidor est√° ativo, redirecionar para fallback
                console.log('‚ùå Nenhum servidor ativo encontrado, redirecionando para fallback...');
                window.location.replace(`http://${currentHost}:5000/fallback.html`);
            }
            
            checkAndRedirect();
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .perfil-card {
            background: white;
            border: 1px solid #ddd;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .info-item {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .info-value {
            margin-top: 5px;
            color: #333;
            font-size: 16px;
            word-break: break-all;
        }
        .hostname {
            color: #007bff;
            font-weight: 500;
        }
        .codigo-sessao {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        button {
            padding: 12px 30px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
        }
        button:hover {
            background-color: #c82333;
        }
        .loading {
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="perfil-card">
        <h1>üë§ Meu Perfil</h1>
        <div class="info-item">
            <div class="info-label">Nome:</div>
            <div class="info-value" id="nome"><span class="loading">Carregando...</span></div>
        </div>
        <div class="info-item">
            <div class="info-label">Servidor (Hostname):</div>
            <div class="info-value hostname" id="hostname"><span class="loading">Carregando...</span></div>
        </div>
        <div class="info-item">
            <div class="info-label">Data e Hora do Login:</div>
            <div class="info-value" id="dataLogin"><span class="loading">Carregando...</span></div>
        </div>
        <div class="info-item">
            <div class="info-label">C√≥digo da Sess√£o:</div>
            <div class="info-value codigo-sessao" id="codigoSessao"><span class="loading">Carregando...</span></div>
        </div>
        <button onclick="logout()">üö™ Sair</button>
    </div>

    <script src="/js/api-client.js"></script>
    <script>
        async function carregarPerfil() {
            try {
                const response = await apiClient.get('/api/meu-perfil');
                
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar perfil');
                }
                
                const data = await response.json();
                
                document.getElementById('nome').textContent = data.nome;
                document.getElementById('hostname').textContent = data.hostname;
                
                // Formatar data
                const dataLogin = new Date(data.data_login);
                document.getElementById('dataLogin').textContent = 
                    dataLogin.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                
                document.getElementById('codigoSessao').textContent = data.codigo_sessao;
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                const errorMsg = error.message || 'Erro desconhecido';
                
                // Se √© erro de "nenhum servidor dispon√≠vel", redirecionar para fallback
                if (errorMsg.includes('Nenhum servidor') || errorMsg.includes('dispon√≠vel')) {
                    console.log('‚ùå Nenhum servidor dispon√≠vel, redirecionando para fallback...');
                    window.location.href = '/fallback.html';
                    return;
                }
                
                // Tentar recarregar (vai tentar pr√≥ximo servidor automaticamente)
                console.log('üîÑ Tentando recarregar perfil em outro servidor...');
                setTimeout(() => carregarPerfil(), 1000);
            }
        }
        
        async function logout() {
            try {
                await apiClient.post('/api/logout', {});
            } catch (error) {
                console.error('Erro no logout:', error);
            }
            
            // Limpar cookie e redirecionar
            document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/';
        }
        
        // Carregar perfil ao abrir a p√°gina
        carregarPerfil();
    </script>
</body>
</html>

