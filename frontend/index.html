<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Meu Trabalho</title>
    <!-- Script de detec√ß√£o de servidor ativo - executa imediatamente -->
    <script>
        (function() {
            // Este script tenta detectar se o servidor atual est√° ativo
            // Se n√£o estiver, tenta outros servidores ANTES de mostrar erro
            const currentHost = window.location.hostname;
            const currentPort = window.location.port || '5000';
            const currentPath = window.location.pathname;
            // Sempre usar portas diferentes (estrat√©gia de portas)
            const servers = ['5000', '5001', '5002'];
            
            // Detectar se precisa testar servidores
            let testedCurrent = false;
            
            async function testServer(serverAddr) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 1000);
                    const url = serverAddr.includes(':') ? `http://${serverAddr}/api/health` : `http://${currentHost}:${serverAddr}/api/health`;
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'include',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response && response.ok;
                } catch (e) {
                    return false;
                }
            }
            
            async function checkAndRedirect() {
                // Testar servidor atual primeiro
                if (!testedCurrent) {
                    testedCurrent = true;
                    const currentServer = currentPort || '5000';
                    const currentActive = await testServer(currentServer);
                    if (currentActive) {
                        return; // Servidor atual est√° ativo, continuar normalmente
                    }
                }
                
                // Servidor atual inativo, procurar outro
                for (const server of servers) {
                    if (server !== currentPort && server !== `:${currentPort}`) {
                        const isActive = await testServer(server);
                        if (isActive) {
                            // Redirecionar para servidor ativo
                            const redirectUrl = server.includes(':') 
                                ? `http://${server}${currentPath}${window.location.search}`
                                : `http://${currentHost}:${server}${currentPath}${window.location.search}`;
                            console.log(`üîÑ Redirecionando para servidor ativo: ${redirectUrl}`);
                            window.location.replace(redirectUrl);
                            return;
                        }
                    }
                }
                
                // Nenhum servidor ativo - redirecionar para fallback
                console.log('‚ùå Nenhum servidor ativo encontrado, redirecionando para fallback...');
                window.location.replace(`http://${currentHost}:5000/fallback.html`);
            }
            
            // Executar imediatamente
            checkAndRedirect();
        })();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .erro {
            color: #dc3545;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
            display: none;
        }
        .erro.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>üîê Login</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="login">Login:</label>
                <input type="text" id="login" name="login" required autocomplete="username">
            </div>
            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" name="senha" required autocomplete="current-password">
            </div>
            <button type="submit" id="submitBtn">Entrar</button>
            <div id="erro" class="erro"></div>
        </form>
    </div>

    <script src="/js/api-client.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const login = document.getElementById('login').value;
            const senha = document.getElementById('senha').value;
            const erroDiv = document.getElementById('erro');
            const submitBtn = document.getElementById('submitBtn');
            
            // Limpar erro anterior
            erroDiv.classList.remove('visible');
            erroDiv.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Entrando...';
            
            try {
                const response = await apiClient.post('/api/login', { login, senha });
                const data = await response.json();
                
                if (response.ok) {
                    // Salvar URL base do servidor ativo para usar na pr√≥xima p√°gina
                    sessionStorage.setItem('apiBaseUrl', apiClient.baseUrl || apiClient.servers[apiClient.currentServerIndex].url);
                    window.location.href = '/perfil.html';
                } else {
                    erroDiv.textContent = data.erro || 'Erro ao fazer login';
                    erroDiv.classList.add('visible');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Entrar';
                }
            } catch (error) {
                erroDiv.textContent = 'Erro de conex√£o. Nenhum servidor dispon√≠vel. Verifique se os containers est√£o rodando.';
                erroDiv.classList.add('visible');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Entrar';
            }
        });
    </script>
</body>
</html>

